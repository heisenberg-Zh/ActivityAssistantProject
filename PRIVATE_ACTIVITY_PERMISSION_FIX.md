# ç§å¯†æ´»åŠ¨æƒé™å’ŒUIä¿®å¤æ–‡æ¡£

## ğŸ“‹ ä¿®å¤æ¦‚è¿°

**ä¿®å¤æ—¥æœŸ**: 2025-11-16
**é—®é¢˜æ¥æº**: ç”¨æˆ·åé¦ˆ

## ğŸ› é—®é¢˜æè¿°

### é—®é¢˜1: åˆ›å»ºè€…æ— æ³•æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„ç§å¯†æ´»åŠ¨

**ç°è±¡**:
- ç”¨æˆ·åˆ›å»ºå®Œæˆç§å¯†æ´»åŠ¨å
- è·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…é¡µ
- æ˜¾ç¤º"æ— æ³•æŸ¥çœ‹æ­¤æ´»åŠ¨"æç¤ºé¡µé¢
- æç¤º"è¿™æ˜¯ä¸€ä¸ªç§å¯†æ´»åŠ¨,ä»…åˆ›å»ºè€…å’Œå·²æŠ¥åè€…å¯è§"

**é—®é¢˜åŸå› **:
- æƒé™æ£€æŸ¥é€»è¾‘ä¸­,åˆ›å»ºè€…æƒé™æ£€æŸ¥ä¸å¤Ÿå¥å£®
- `isPublic` å­—æ®µç±»å‹åˆ¤æ–­ä¸å‡†ç¡®ï¼ˆå¯èƒ½æ˜¯ Boolean/String/Numberï¼‰
- ç®¡ç†å‘˜æƒé™æœªçº³å…¥æ£€æŸ¥èŒƒå›´

### é—®é¢˜2: æ— æƒé™é¡µé¢æŒ‰é’®å¸ƒå±€ä¸å¯¹ç§°

**ç°è±¡**:
- "è¿”å›é¦–é¡µ"å’Œ"æµè§ˆæ´»åŠ¨"ä¸¤ä¸ªæŒ‰é’®å‚ç›´æ’åˆ—
- å·¦å³ä¸å¯¹ç§°,ä¸ç¾è§‚

**æœŸæœ›æ•ˆæœ**:
- ä¸¤ä¸ªæŒ‰é’®æ°´å¹³æ’åˆ—
- å·¦å³å¯¹ç§°,å±…ä¸­æ˜¾ç¤º

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1: å¢å¼ºæƒé™æ£€æŸ¥é€»è¾‘

**ä¿®æ”¹æ–‡ä»¶**: `utils/activity-helper.js`

**æ”¹è¿›ç‚¹**:

#### 1. å¢åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
```javascript
console.log('[æƒé™æ£€æŸ¥] æ´»åŠ¨ID:', activity.id || activity.activity_id);
console.log('[æƒé™æ£€æŸ¥] æ´»åŠ¨å…¬å¼€çŠ¶æ€:', activity.isPublic, 'ç±»å‹:', typeof activity.isPublic);
console.log('[æƒé™æ£€æŸ¥] ç»„ç»‡è€…ID:', activity.organizerId);
console.log('[æƒé™æ£€æŸ¥] å½“å‰ç”¨æˆ·ID:', currentUserId);
console.log('[æƒé™æ£€æŸ¥] æ˜¯å¦ä»åˆ†äº«è®¿é—®:', fromShare);
```

#### 2. å¥å£®çš„å…¬å¼€çŠ¶æ€åˆ¤æ–­
```javascript
// ä¿®æ”¹å‰
if (activity.isPublic) {
  return { hasPermission: true };
}

// ä¿®æ”¹å - å…¼å®¹å¤šç§æ•°æ®ç±»å‹
if (activity.isPublic === true || activity.isPublic === 'true' || activity.isPublic === 1) {
  console.log('[æƒé™æ£€æŸ¥] æ´»åŠ¨å…¬å¼€ï¼Œå…è®¸è®¿é—®');
  return { hasPermission: true };
}
```

#### 3. ä¼˜å…ˆæ£€æŸ¥åˆ›å»ºè€…æƒé™
```javascript
// 1. åˆ›å»ºè€…å¯ä»¥æŸ¥çœ‹ï¼ˆæœ€ä¼˜å…ˆæ£€æŸ¥ï¼‰
if (activity.organizerId && activity.organizerId === currentUserId) {
  console.log('[æƒé™æ£€æŸ¥] å½“å‰ç”¨æˆ·æ˜¯åˆ›å»ºè€…ï¼Œå…è®¸è®¿é—®');
  return { hasPermission: true };
}
```

#### 4. æ–°å¢ç®¡ç†å‘˜æƒé™æ£€æŸ¥
```javascript
// 2. ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹
if (activity.administrators && Array.isArray(activity.administrators)) {
  const isAdmin = activity.administrators.some(admin =>
    admin.userId === currentUserId || admin === currentUserId
  );
  if (isAdmin) {
    console.log('[æƒé™æ£€æŸ¥] å½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œå…è®¸è®¿é—®');
    return { hasPermission: true };
  }
}
```

#### 5. å®Œæ•´çš„æƒé™æ£€æŸ¥ä¼˜å…ˆçº§

æ–°çš„æƒé™æ£€æŸ¥é¡ºåºï¼ˆä»é«˜åˆ°ä½ï¼‰:

1. âœ… **å·²åˆ é™¤æ£€æŸ¥** - å·²åˆ é™¤çš„æ´»åŠ¨ä¸å¯è®¿é—®
2. âœ… **å…¬å¼€æ´»åŠ¨** - å…¬å¼€æ´»åŠ¨æ‰€æœ‰äººéƒ½å¯æŸ¥çœ‹
3. âœ… **åˆ›å»ºè€…æƒé™** - åˆ›å»ºè€…å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ç§å¯†æ´»åŠ¨
4. âœ… **ç®¡ç†å‘˜æƒé™** - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç®¡ç†çš„ç§å¯†æ´»åŠ¨
5. âœ… **åˆ†äº«é“¾æ¥** - é€šè¿‡åˆ†äº«é“¾æ¥è®¿é—®å¯ä»¥æŸ¥çœ‹
6. âœ… **å·²æŠ¥åç”¨æˆ·** - å·²æŠ¥åä¸”å®¡æ ¸é€šè¿‡çš„ç”¨æˆ·å¯ä»¥æŸ¥çœ‹

### ä¿®å¤2: ä¼˜åŒ–æŒ‰é’®å¸ƒå±€

**ä¿®æ”¹æ–‡ä»¶**: `pages/activities/detail.wxss`

**æ”¹è¿›ç‚¹**:

#### ä¿®æ”¹å‰ - å‚ç›´æ’åˆ—
```css
.permission-actions {
  display: flex;
  flex-direction: column;  /* å‚ç›´æ’åˆ— */
  gap: 16rpx;
}

.permission-actions .btn {
  width: 100%;  /* å æ»¡æ•´è¡Œ */
  padding: 24rpx;
  border-radius: 16rpx;
  font-size: 28rpx;
  font-weight: 600;
  text-align: center;
}
```

#### ä¿®æ”¹å - æ°´å¹³å¯¹ç§°å¸ƒå±€
```css
.permission-actions {
  display: flex;
  flex-direction: row;  /* æ°´å¹³æ’åˆ— */
  gap: 24rpx;  /* æŒ‰é’®é—´è· */
  justify-content: center;  /* æ°´å¹³å±…ä¸­ */
  align-items: center;  /* å‚ç›´å±…ä¸­ */
  width: 100%;
}

.permission-actions .btn {
  flex: 1;  /* ç­‰æ¯”ä¾‹åˆ†é…ç©ºé—´ */
  max-width: 280rpx;  /* æœ€å¤§å®½åº¦é™åˆ¶ */
  padding: 24rpx 32rpx;
  border-radius: 16rpx;
  font-size: 28rpx;
  font-weight: 600;
  text-align: center;
}
```

**è§†è§‰æ•ˆæœå¯¹æ¯”**:

ä¿®æ”¹å‰:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     è¿”å›é¦–é¡µ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æµè§ˆæ´»åŠ¨             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä¿®æ”¹å:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›é¦–é¡µ  â”‚  â”‚ æµè§ˆæ´»åŠ¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1: åˆ›å»ºè€…æŸ¥çœ‹ç§å¯†æ´»åŠ¨

**æµ‹è¯•æ­¥éª¤**:
1. åˆ›å»ºä¸€ä¸ªç§å¯†æ´»åŠ¨ï¼ˆisPublic = falseï¼‰
2. ç‚¹å‡»"å‘å¸ƒ"
3. è‡ªåŠ¨è·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…é¡µ

**é¢„æœŸç»“æœ**:
- âœ… æ­£å¸¸æ˜¾ç¤ºæ´»åŠ¨è¯¦æƒ…
- âœ… ä¸æ˜¾ç¤º"æ— æ³•æŸ¥çœ‹æ­¤æ´»åŠ¨"æç¤º
- âœ… æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º: `[æƒé™æ£€æŸ¥] å½“å‰ç”¨æˆ·æ˜¯åˆ›å»ºè€…ï¼Œå…è®¸è®¿é—®`

### æµ‹è¯•åœºæ™¯2: éåˆ›å»ºè€…æŸ¥çœ‹ç§å¯†æ´»åŠ¨

**æµ‹è¯•æ­¥éª¤**:
1. ç™»å‡ºå½“å‰ç”¨æˆ·
2. ç”¨å¦ä¸€ä¸ªç”¨æˆ·ç™»å½•
3. ç›´æ¥è®¿é—®ç§å¯†æ´»åŠ¨è¯¦æƒ…é¡µ

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"æ— æ³•æŸ¥çœ‹æ­¤æ´»åŠ¨"æç¤ºé¡µé¢
- âœ… ä¸¤ä¸ªæŒ‰é’®æ°´å¹³æ’åˆ—,å·¦å³å¯¹ç§°
- âœ… æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º: `[æƒé™æ£€æŸ¥] æ— è®¿é—®æƒé™`

### æµ‹è¯•åœºæ™¯3: é€šè¿‡åˆ†äº«é“¾æ¥è®¿é—®ç§å¯†æ´»åŠ¨

**æµ‹è¯•æ­¥éª¤**:
1. åˆ›å»ºç§å¯†æ´»åŠ¨
2. ç”Ÿæˆåˆ†äº«é“¾æ¥ï¼ˆåŒ…å« `from=share` å‚æ•°ï¼‰
3. ç”¨å…¶ä»–ç”¨æˆ·ç‚¹å‡»åˆ†äº«é“¾æ¥

**é¢„æœŸç»“æœ**:
- âœ… æ­£å¸¸æ˜¾ç¤ºæ´»åŠ¨è¯¦æƒ…
- âœ… æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º: `[æƒé™æ£€æŸ¥] é€šè¿‡åˆ†äº«é“¾æ¥è®¿é—®ï¼Œå…è®¸è®¿é—®`

### æµ‹è¯•åœºæ™¯4: ç®¡ç†å‘˜æŸ¥çœ‹ç§å¯†æ´»åŠ¨

**æµ‹è¯•æ­¥éª¤**:
1. åˆ›å»ºç§å¯†æ´»åŠ¨
2. æ·»åŠ ç®¡ç†å‘˜
3. ç”¨ç®¡ç†å‘˜è´¦å·è®¿é—®æ´»åŠ¨è¯¦æƒ…é¡µ

**é¢„æœŸç»“æœ**:
- âœ… æ­£å¸¸æ˜¾ç¤ºæ´»åŠ¨è¯¦æƒ…
- âœ… æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º: `[æƒé™æ£€æŸ¥] å½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œå…è®¸è®¿é—®`

### æµ‹è¯•åœºæ™¯5: å·²æŠ¥åç”¨æˆ·æŸ¥çœ‹ç§å¯†æ´»åŠ¨

**æµ‹è¯•æ­¥éª¤**:
1. åˆ›å»ºç§å¯†æ´»åŠ¨
2. ç”¨æˆ·AæŠ¥åå¹¶å®¡æ ¸é€šè¿‡
3. ç”¨æˆ·Aè®¿é—®æ´»åŠ¨è¯¦æƒ…é¡µ

**é¢„æœŸç»“æœ**:
- âœ… æ­£å¸¸æ˜¾ç¤ºæ´»åŠ¨è¯¦æƒ…
- âœ… æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º: `[æƒé™æ£€æŸ¥] ç”¨æˆ·å·²æŠ¥åä¸”å®¡æ ¸é€šè¿‡ï¼Œå…è®¸è®¿é—®`

## ğŸ“Š æƒé™æ£€æŸ¥æµç¨‹å›¾

```
å¼€å§‹
  â”‚
  â”œâ”€ æ´»åŠ¨å·²åˆ é™¤ï¼Ÿ
  â”‚    â”œâ”€ æ˜¯ â†’ æ‹’ç»è®¿é—® âŒ
  â”‚    â””â”€ å¦ â†“
  â”‚
  â”œâ”€ æ´»åŠ¨å…¬å¼€ï¼Ÿ
  â”‚    â”œâ”€ æ˜¯ â†’ å…è®¸è®¿é—® âœ…
  â”‚    â””â”€ å¦ â†“
  â”‚
  â”œâ”€ æ˜¯åˆ›å»ºè€…ï¼Ÿ
  â”‚    â”œâ”€ æ˜¯ â†’ å…è®¸è®¿é—® âœ…
  â”‚    â””â”€ å¦ â†“
  â”‚
  â”œâ”€ æ˜¯ç®¡ç†å‘˜ï¼Ÿ
  â”‚    â”œâ”€ æ˜¯ â†’ å…è®¸è®¿é—® âœ…
  â”‚    â””â”€ å¦ â†“
  â”‚
  â”œâ”€ é€šè¿‡åˆ†äº«é“¾æ¥ï¼Ÿ
  â”‚    â”œâ”€ æ˜¯ â†’ å…è®¸è®¿é—® âœ…
  â”‚    â””â”€ å¦ â†“
  â”‚
  â”œâ”€ å·²æŠ¥åä¸”å®¡æ ¸é€šè¿‡ï¼Ÿ
  â”‚    â”œâ”€ æ˜¯ â†’ å…è®¸è®¿é—® âœ…
  â”‚    â””â”€ å¦ â†“
  â”‚
  â””â”€ æ‹’ç»è®¿é—® âŒ
```

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æƒé™æ£€æŸ¥æ—¥å¿—

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†çš„æƒé™æ£€æŸ¥æ—¥å¿—:

```
[æƒé™æ£€æŸ¥] æ´»åŠ¨ID: A20251116000001
[æƒé™æ£€æŸ¥] æ´»åŠ¨å…¬å¼€çŠ¶æ€: false ç±»å‹: boolean
[æƒé™æ£€æŸ¥] ç»„ç»‡è€…ID: u7d3f31690438
[æƒé™æ£€æŸ¥] å½“å‰ç”¨æˆ·ID: u7d3f31690438
[æƒé™æ£€æŸ¥] æ˜¯å¦ä»åˆ†äº«è®¿é—®: false
[æƒé™æ£€æŸ¥] å½“å‰ç”¨æˆ·æ˜¯åˆ›å»ºè€…ï¼Œå…è®¸è®¿é—®
```

### å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜: åˆ›å»ºè€…ä»ç„¶æ— æ³•æŸ¥çœ‹ç§å¯†æ´»åŠ¨

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ä¸­çš„ `ç»„ç»‡è€…ID` å’Œ `å½“å‰ç”¨æˆ·ID` æ˜¯å¦ä¸€è‡´
2. æ£€æŸ¥ `æ´»åŠ¨å…¬å¼€çŠ¶æ€` çš„ç±»å‹å’Œå€¼
3. ç¡®è®¤ `app.globalData.currentUserId` æ˜¯å¦æ­£ç¡®è®¾ç½®

#### é—®é¢˜: æŒ‰é’®ä»ç„¶ä¸å¯¹ç§°

**æ’æŸ¥æ­¥éª¤**:
1. æ¸…é™¤å¾®ä¿¡å¼€å‘è€…å·¥å…·ç¼“å­˜ï¼ˆå·¥å…· > æ¸…é™¤ç¼“å­˜ï¼‰
2. é‡æ–°ç¼–è¯‘é¡¹ç›®
3. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ ·å¼è¦†ç›–äº† `.permission-actions`

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|---------|---------|------|
| `utils/activity-helper.js` | å¢å¼ºæƒé™æ£€æŸ¥é€»è¾‘ | 56-114 |
| `pages/activities/detail.wxss` | ä¼˜åŒ–æŒ‰é’®å¸ƒå±€ | 53-70 |

### ç›¸å…³æ–‡ä»¶ï¼ˆæœªä¿®æ”¹ï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `pages/activities/detail.js` | è°ƒç”¨æƒé™æ£€æŸ¥çš„é¡µé¢é€»è¾‘ |
| `pages/activities/detail.wxml` | æ— æƒé™é¡µé¢çš„HTMLç»“æ„ |
| `utils/activity-management-helper.js` | ç®¡ç†æƒé™æ£€æŸ¥è¾…åŠ©å‡½æ•° |

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. åç«¯æƒé™æ ¡éªŒ

å½“å‰æƒé™æ£€æŸ¥åœ¨å‰ç«¯è¿›è¡Œ,å»ºè®®åç«¯ä¹Ÿå®ç°åŒæ ·çš„æƒé™æ ¡éªŒé€»è¾‘,ç¡®ä¿å®‰å…¨æ€§ã€‚

**åç«¯å®ç°ç¤ºä¾‹**:
```java
@GetMapping("/{id}")
public ApiResponse<ActivityVO> getActivityDetail(@PathVariable String id) {
    String userId = SecurityUtils.getCurrentUserIdOrNull();
    Activity activity = activityRepository.findById(id)
        .orElseThrow(() -> new BusinessException(404, "æ´»åŠ¨ä¸å­˜åœ¨"));

    // æƒé™æ£€æŸ¥
    if (!activity.isPublic()) {
        boolean hasPermission =
            activity.getOrganizerId().equals(userId) ||  // åˆ›å»ºè€…
            isAdmin(activity, userId) ||                 // ç®¡ç†å‘˜
            hasApprovedRegistration(activity.getId(), userId);  // å·²æŠ¥å

        if (!hasPermission) {
            throw new BusinessException(403, "æ— æƒæŸ¥çœ‹æ­¤ç§å¯†æ´»åŠ¨");
        }
    }

    return ApiResponse.success(activityMapper.toVO(activity, userId));
}
```

### 2. åˆ†äº«é“¾æ¥æƒé™æ§åˆ¶

è€ƒè™‘ä¸ºåˆ†äº«é“¾æ¥æ·»åŠ æœ‰æ•ˆæœŸæˆ–è®¿é—®æ¬¡æ•°é™åˆ¶:

```javascript
// ç”Ÿæˆå¸¦æœ‰æ—¶æ•ˆçš„åˆ†äº«token
const shareToken = generateShareToken(activityId, {
  expiresIn: 7 * 24 * 60 * 60 * 1000,  // 7å¤©æœ‰æ•ˆ
  maxVisits: 100  // æœ€å¤šè®¿é—®100æ¬¡
});

// åˆ†äº«é“¾æ¥
const shareUrl = `/pages/activities/detail?id=${activityId}&token=${shareToken}`;
```

### 3. æƒé™å˜æ›´é€šçŸ¥

å½“æ´»åŠ¨ä»å…¬å¼€æ”¹ä¸ºç§å¯†æ—¶,é€šçŸ¥å·²å…³æ³¨çš„ç”¨æˆ·:

```javascript
async function changePrivacySetting(activityId, isPublic) {
  // æ›´æ–°æ´»åŠ¨è®¾ç½®
  await updateActivity(activityId, { isPublic });

  // å¦‚æœæ”¹ä¸ºç§å¯†ï¼Œé€šçŸ¥ç›¸å…³ç”¨æˆ·
  if (!isPublic) {
    const followers = await getActivityFollowers(activityId);
    await notifyPrivacyChange(followers, activityId);
  }
}
```

### 4. UIä¼˜åŒ– - å“åº”å¼å¸ƒå±€

é’ˆå¯¹ä¸åŒå±å¹•å°ºå¯¸ä¼˜åŒ–æŒ‰é’®å¸ƒå±€:

```css
.permission-actions {
  display: flex;
  flex-direction: row;
  gap: 24rpx;
  justify-content: center;
  align-items: center;
  width: 100%;
}

/* å°å±å¹•ï¼ˆ<375pxï¼‰å‚ç›´æ’åˆ— */
@media (max-width: 750rpx) {
  .permission-actions {
    flex-direction: column;
  }

  .permission-actions .btn {
    max-width: 100%;
  }
}
```

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [å¾®ä¿¡å°ç¨‹åº - åˆ†äº«åŠŸèƒ½](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/share.html)
- [Flexbox å¸ƒå±€æŒ‡å—](https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Flexible_Box_Layout)
- [æƒé™è®¾è®¡æœ€ä½³å®è·µ](https://auth0.com/docs/authorization/concepts/rbac)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ä¿®å¤æ—¥æœŸ**: 2025-11-16
**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ
