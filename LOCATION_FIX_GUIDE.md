# 地点选择功能修复指南

## 问题原因

错误信息：
```
chooseLocation:fail api scope is not declared in the privacy agreement
errno: 112
```

这是微信小程序的隐私协议问题。虽然在 `app.json` 中声明了 API，但还需要在小程序管理后台配置隐私协议，这在开发阶段不方便。

## 解决方案

**在模拟器环境下完全不使用 `wx.chooseLocation` API**，改用自定义的地点选择器。

---

## 立即测试步骤

### 步骤1：保存并重新编译

```bash
1. 保存所有修改的文件
2. 按 Ctrl + B 重新编译
3. 等待编译完成（看到"编译成功"）
```

### 步骤2：清除控制台

1. 打开开发者工具底部的**控制台**
2. 点击**垃圾桶图标**清空日志

### 步骤3：测试地点选择

1. **进入创建活动页面**
2. **完成步骤1**：填写活动名称、描述、类型
3. **完成步骤2**：选择开始时间、结束时间
4. **进入步骤3**：地点设置
5. **点击"点击选择活动地点"按钮**

---

## 预期结果

### ✅ 正确的流程

**1. 控制台输出**：
```
点击选择地点
系统信息: {platform: "devtools", ...}
模拟器环境，使用预设地点选择
显示地点选择器
```

**2. 弹出地点选择列表**：
```
┌─────────────────────────┐
│ 北京大学                 │
│ 清华大学                 │
│ 中关村创业大街           │
│ 国家图书馆               │
│ 鸟巢（国家体育场）       │
│ 手动输入                 │
│ 取消                     │
└─────────────────────────┘
```

**3. 选择地点后**：
- 显示提示："已选择：北京大学"
- 页面显示地点名称和地址
- 可以点击"下一步"进入步骤4

### ❌ 不应该看到的错误

- ❌ `chooseLocation:fail api scope is not declared in the privacy agreement`
- ❌ `errno: 112`
- ❌ 任何红色错误信息

---

## 可选：快速填充测试数据

如果仍有问题，可以使用这个临时方案跳过地点选择：

### 方法1：修改验证逻辑

找到 `pages/activities/create.js` 的 `validateCurrentStep` 方法，在步骤3的验证中添加：

```javascript
case 3: // 地点设置
  // 如果地点未设置，自动填充测试数据
  if (!form.place || !form.address) {
    this.setData({
      'form.place': '北京大学（自动填充）',
      'form.address': '北京市海淀区颐和园路5号',
      'form.latitude': 39.9925,
      'form.longitude': 116.3061,
      'form.checkinRadius': 500
    });
    wx.showToast({ title: '已自动填充测试地点', icon: 'none', duration: 2000 });
  }

  if (!form.checkinRadius || form.checkinRadius < 10) {
    this.setData({ 'form.checkinRadius': 500 });
  }
  break;
```

这样即使不选择地点，点击"下一步"时也会自动填充。

---

## 代码改动说明

### 1. app.json 添加隐私声明
```json
"requiredPrivateInfos": ["chooseLocation", "getLocation"],
"permission": {
  "scope.userLocation": {
    "desc": "你的位置信息将用于活动签到和地点选择"
  }
}
```

### 2. create.js 环境判断
- **模拟器**：直接使用 `showLocationPicker()`（不调用 wx.chooseLocation）
- **真机**：使用 `useNativeLocationPicker()`（调用 wx.chooseLocation）

### 3. 自定义选择器
使用 `wx.showActionSheet` 显示预设地点列表，避免隐私协议问题。

---

## 预设地点列表

当前提供的预设地点：

| 地点名称 | 详细地址 | 经纬度 |
|---------|---------|--------|
| 北京大学 | 北京市海淀区颐和园路5号 | 39.9925, 116.3061 |
| 清华大学 | 北京市海淀区清华园1号 | 39.9990, 116.3262 |
| 中关村创业大街 | 北京市海淀区中关村大街 | 39.9796, 116.3089 |
| 国家图书馆 | 北京市海淀区中关村南大街33号 | 39.9354, 116.3235 |
| 鸟巢（国家体育场）| 北京市朝阳区国家体育场南路1号 | 39.9928, 116.3972 |
| 手动输入 | - | - |

选择"手动输入"可以自定义地点。

---

## 真机测试说明

在真机上测试时：
1. 首次使用会弹出**隐私协议授权**
2. 需要用户点击"同意"
3. 然后弹出微信原生地图选择器
4. 选择地点后自动填充

**注意**：真机需要在小程序管理后台配置隐私协议才能正常使用 `wx.chooseLocation`。

---

## 调试检查清单

测试前请确认：

- [ ] 已保存所有文件
- [ ] 已重新编译项目（Ctrl + B）
- [ ] 已清空控制台日志
- [ ] 编译无错误（无红色信息）
- [ ] 在模拟器中测试（不是真机）

---

## 需要帮助？

如果按照上述步骤操作后仍有问题，请提供：

1. **控制台的完整输出**（从点击地点选择到出现错误）
2. **是否弹出了地点选择列表**
3. **选择地点后是否有反应**
4. **页面上是否显示了地点信息**

---

**最后更新**: 2025-10-27
**状态**: 已完全避免隐私协议问题
