# 开发登录问题解决方案

## 问题现象
点击"开发模式登录（快捷）"后，提示"开发登录失败"。

## 原因分析
开发模式登录需要调用本地后端API（`http://localhost:8082`），但微信开发者工具默认会**检查域名是否合法**，导致对localhost的请求被拦截。

## 解决方案（三选一）

### ✅ 方案一：禁用域名校验（推荐，最简单）

1. 打开微信开发者工具
2. 点击右上角"详情"按钮
3. 找到"本地设置"标签页
4. 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

**完成后**：
- 重新点击"开发模式登录"按钮
- 应该能正常登录，获取真实Token和用户信息

---

### ✅ 方案二：使用自动降级模式（已实现）

**无需任何配置**，系统会自动处理：

1. **优先尝试**：调用后端API获取真实Token
2. **自动降级**：如果后端连接失败，自动切换到纯前端Mock模式
3. **离线可用**：即使没有后端服务，也能正常开发调试

**特点**：
- ✅ 无需配置
- ✅ 自动识别
- ✅ 离线可用
- ✅ 显示提示"开发登录成功（离线）"

**离线模式数据**：
- 用户名：Test User
- 角色：活动组织者（离线）
- 创建活动：12个
- 参与活动：25个
- 签到率：95%

---

### ✅ 方案三：启动后端服务（获取真实数据）

如果你需要获取后端真实数据：

1. **确认后端已启动**
   ```bash
   # 在后端项目目录执行
   cd backend
   ./mvnw spring-boot:run

   # 或者使用IDE运行 ActivityApplication.java
   ```

2. **验证后端运行**
   ```bash
   # 访问健康检查接口
   http://localhost:8082/api/health

   # 应返回：{"status":"ok"}
   ```

3. **确认配置正确**
   - 文件：`utils/config.js`
   - 当前环境：`development`
   - API地址：`http://localhost:8082`
   - Mock模式：`false`

4. **禁用域名校验**（见方案一）

---

## 验证登录成功

登录成功后，控制台会显示：

### 后端模式（方案一、三）：
```
📡 尝试调用后端登录API（开发模式）
✅ 开发模式登录成功（后端）
💾 步骤3: 保存用户信息和token
✅ 用户信息保存成功
```

### 离线模式（方案二）：
```
⚠️ 后端登录失败，尝试使用纯前端Mock模式
🎭 使用纯前端Mock模式登录
✅ Mock登录成功（纯前端模式）
```

---

## "我的"页面数据来源

登录成功后，点击"我的"页面：

### 后端模式：
- ✅ 从真实后端API获取数据
- ✅ 调用 `/api/user/profile` 获取用户信息
- ✅ 调用 `/api/statistics/my` 获取统计数据
- ✅ 显示真实的活动数量和签到率

### 离线模式：
- ✅ 从本地存储读取Mock数据
- ✅ 显示角色为"活动组织者（离线）"
- ✅ 显示预设的统计数据（12/25/95%）
- ✅ 无需网络连接

---

## 推荐开发流程

### 场景1：本地全栈开发
1. 启动后端服务（端口8082）
2. 禁用域名校验（方案一）
3. 点击"开发模式登录"
4. ✅ 获取真实Token和数据

### 场景2：纯前端开发（无后端）
1. 无需启动后端
2. 可以不禁用域名校验
3. 点击"开发模式登录"
4. ✅ 自动使用离线Mock数据

### 场景3：真机测试
1. 不要使用开发模式登录
2. 使用"微信授权登录"按钮
3. 需要配置后端为HTTPS域名
4. 需要在微信公众平台配置合法域名

---

## 常见问题

### Q1: 为什么需要禁用域名校验？
**A**: 微信小程序要求所有网络请求必须使用HTTPS，并且域名需要在微信公众平台配置。开发环境使用`http://localhost`不符合要求，所以需要在开发者工具中禁用校验。

### Q2: 禁用域名校验安全吗？
**A**: 仅在开发者工具中禁用，不影响真机和线上环境。真机和正式版本仍然会进行域名校验。

### Q3: 离线模式的数据是假的吗？
**A**: 是的，离线模式使用预设的Mock数据。如需真实数据，请启动后端服务并禁用域名校验。

### Q4: 如何区分当前是后端模式还是离线模式？
**A**:
- 登录成功提示："开发登录成功" = 后端模式
- 登录成功提示："开发登录成功（离线）" = 离线模式
- "我的"页面角色："活动组织者（离线）" = 离线模式

### Q5: 生产环境怎么办？
**A**: 生产环境不使用开发模式登录，使用"微信授权登录"按钮，并配置真实的HTTPS后端域名。

---

## 配置文件说明

### utils/config.js
```javascript
const CURRENT_ENV = 'development'; // 当前环境

const ENV_CONFIG = {
  development: {
    baseUrl: 'http://localhost:8082',  // 后端地址
    useMock: false,                    // 不使用Mock模式
    description: '开发环境（需禁用域名校验）'
  },
  mock: {
    baseUrl: '',
    useMock: true,                     // 使用前端Mock
    description: 'Mock模式（使用本地假数据）'
  }
};
```

---

## 技术架构

```
┌─────────────────────────────────────────────────┐
│          开发模式登录流程                         │
└─────────────────────────────────────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │ 尝试调用后端API   │
           └──────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
      成功                         失败
        │                           │
        ▼                           ▼
┌───────────────┐          ┌───────────────┐
│  后端模式     │          │  离线模式     │
│  真实Token    │          │  Mock Token   │
│  真实数据     │          │  Mock数据     │
└───────────────┘          └───────────────┘
        │                           │
        └─────────────┬─────────────┘
                      │
                      ▼
            ┌──────────────────┐
            │  跳转到首页       │
            └──────────────────┘
                      │
                      ▼
            ┌──────────────────┐
            │  点击"我的"       │
            └──────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
  后端模式                      离线模式
        │                           │
        ▼                           ▼
┌───────────────┐          ┌───────────────┐
│  调用API      │          │  读本地存储   │
│  显示真实数据  │          │  显示Mock数据 │
└───────────────┘          └───────────────┘
```

---

## 总结

**最简单的解决方案**：在微信开发者工具中禁用域名校验（方案一）

**最灵活的方案**：什么都不用配置，系统自动处理（方案二）

**获取真实数据**：启动后端 + 禁用域名校验（方案三）

选择适合你的开发场景的方案即可！
