<!-- pages/registration/index.wxml -->
<view class="registration-header">
  <text class="registration-title">{{detail.title}}</text>
</view>

<!-- åˆ†ç»„é€‰æ‹©ç•Œé¢ -->
<view wx:if="{{showGroupSelection && detail.hasGroups && detail.groups}}" class="group-selection-section">
  <view class="section-header">
    <text class="section-title-large">è¯·é€‰æ‹©æŠ¥ååˆ†ç»„</text>
    <text class="section-subtitle">æ´»åŠ¨åˆ†ä¸ºå¤šä¸ªç»„åˆ«ï¼Œè¯·æ ¹æ®è‡ªèº«æƒ…å†µé€‰æ‹©åˆé€‚çš„åˆ†ç»„</text>
  </view>

  <view class="groups-list">
    <block wx:for="{{detail.groups}}" wx:key="id" wx:for-item="group">
      <view class="group-card {{group.joined >= group.total ? 'group-card--full' : ''}}">
        <view class="group-card-header">
          <text class="group-card-name">{{group.name}}</text>
          <view class="group-card-status">
            <text class="group-card-count {{group.joined >= group.total ? 'group-card-count--full' : ''}}">
              {{group.joined}}/{{group.total}}äºº
            </text>
            <text wx:if="{{group.joined >= group.total}}" class="group-card-full-badge">å·²æ»¡</text>
          </view>
        </view>

        <view wx:if="{{group.description}}" class="group-card-desc">
          <text class="desc-text">{{group.description}}</text>
        </view>

        <view class="group-card-info">
          <view class="group-info-item">
            <text class="info-icon">ğŸ’°</text>
            <text class="info-text">{{group.feeType}} {{group.feeType !== 'å…è´¹' ? 'Â¥' + group.fee : ''}}</text>
          </view>
        </view>

        <view wx:if="{{group.requirements}}" class="group-card-requirements">
          <text class="requirements-label">âš ï¸ æŠ¥åè¦æ±‚ï¼š</text>
          <text class="requirements-text">{{group.requirements}}</text>
        </view>

        <view class="group-card-action" bindtap="selectGroup" data-group-id="{{group.id}}">
          <text class="action-text">{{group.joined >= group.total ? 'å·²æ»¡å‘˜' : 'é€‰æ‹©æ­¤ç»„'}}</text>
        </view>
      </view>
    </block>
  </view>
</view>

<!-- æ´»åŠ¨ä¿¡æ¯å¡ç‰‡ï¼ˆéåˆ†ç»„é€‰æ‹©æ—¶æ˜¾ç¤ºï¼‰ -->
<view wx:if="{{!showGroupSelection}}" class="activity-info-section">
  <view class="activity-info-card">
    <!-- æ´»åŠ¨å°é¢å’ŒçŠ¶æ€ -->
    <view class="activity-cover banner--{{detail.banner}}">
      <view class="cover-badges">
        <view class="cover-badge cover-badge--status">{{detail.status}}</view>
        <view class="cover-badge cover-badge--type">{{detail.type}}</view>
      </view>
    </view>

    <!-- æ´»åŠ¨æè¿° -->
    <view class="activity-desc">
      <text class="desc-text">{{detail.desc}}</text>
    </view>

    <!-- å…³é”®ä¿¡æ¯ç½‘æ ¼ -->
    <view class="info-grid">
      <view class="info-grid-item">
        <view class="info-grid-icon info-grid-icon--time">
          <text class="icon-emoji">ğŸ•</text>
        </view>
        <view class="info-grid-content">
          <text class="info-grid-label">æ´»åŠ¨æ—¶é—´</text>
          <text class="info-grid-value">{{detail.timeRange}}</text>
          <text class="info-grid-sub">æˆªæ­¢ï¼š{{deadline}}</text>
        </view>
      </view>

      <view class="info-grid-item">
        <view class="info-grid-icon info-grid-icon--location">
          <text class="icon-emoji">ğŸ“</text>
        </view>
        <view class="info-grid-content">
          <text class="info-grid-label">æ´»åŠ¨åœ°ç‚¹</text>
          <text class="info-grid-value">{{detail.place}}</text>
          <text class="info-grid-sub">æå‰30åˆ†é’Ÿåˆ°è¾¾</text>
        </view>
      </view>

      <view class="info-grid-item">
        <view class="info-grid-icon info-grid-icon--people">
          <text class="icon-emoji">ğŸ‘¥</text>
        </view>
        <view class="info-grid-content">
          <text class="info-grid-label">å‚ä¸äººæ•°</text>
          <text class="info-grid-value">{{detail.joined}} / {{detail.total}} äºº</text>
          <view class="mini-progress">
            <view class="mini-progress-bar" style="width: {{progress}}%"></view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å·²æŠ¥åçŠ¶æ€æç¤ºï¼ˆå¦‚æœç”¨æˆ·å·²æŠ¥åï¼‰ -->
<view wx:if="{{!showGroupSelection && isRegistered}}" class="registered-status-section">
  <view class="registered-status-card">
    <view class="status-icon">
      <text class="icon-emoji">{{registrationStatus === 'pending' ? 'â³' : 'âœ…'}}</text>
    </view>
    <view class="status-content">
      <text class="status-title">{{registrationStatus === 'pending' ? 'æŠ¥åå®¡æ ¸ä¸­' : 'å·²æˆåŠŸæŠ¥å'}}</text>
      <text class="status-desc">{{registrationStatus === 'pending' ? 'æ‚¨çš„æŠ¥åæ­£åœ¨ç­‰å¾…ç»„ç»‡è€…å®¡æ ¸' : 'æ‚¨å·²æˆåŠŸæŠ¥åæ­¤æ´»åŠ¨'}}</text>
      <text wx:if="{{registeredGroupName}}" class="status-group">æŠ¥ååˆ†ç»„ï¼š{{registeredGroupName}}</text>
    </view>
  </view>
</view>

<!-- æŠ¥åè¡¨å•ï¼ˆéåˆ†ç»„é€‰æ‹©æ—¶æ˜¾ç¤ºï¼‰ -->
<view wx:if="{{!showGroupSelection}}" class="form-section">
  <view class="form-header">
    <text class="form-title">{{isRegistered ? 'æ‚¨çš„æŠ¥åä¿¡æ¯' : 'å¡«å†™æŠ¥åä¿¡æ¯'}}</text>
    <text class="form-subtitle">{{isRegistered ? 'ä»¥ä¸‹æ˜¯æ‚¨æäº¤çš„æŠ¥åä¿¡æ¯' : 'è¯·å¦‚å®å¡«å†™ä»¥ä¸‹ä¿¡æ¯'}}</text>
  </view>

  <view class="form-container">
    <!-- åŠ¨æ€å­—æ®µ -->
    <view class="form-group">
      <block wx:for="{{customFields}}" wx:key="id" wx:for-item="field">
        <view class="input-wrapper">
          <view class="input-label-row">
            <text class="input-label">{{field.label}}</text>
            <text wx:if="{{field.required && !isRegistered}}" class="input-required">*</text>
          </view>
          <input
            class="input-field {{isRegistered ? 'input-field--disabled' : ''}}"
            type="{{field.id === 'mobile' ? 'number' : 'text'}}"
            placeholder="{{field.desc || 'è¯·è¾“å…¥' + field.label}}"
            bindinput="onInput"
            data-field="{{field.id}}"
            value="{{formData[field.id]}}"
            disabled="{{isRegistered}}"
          />
          <text wx:if="{{field.desc}}" class="field-hint" style="font-size: 22rpx; color: #9ca3af; margin-top: 8rpx; display: block;">{{field.desc}}</text>
        </view>
      </block>
    </view>

    <!-- è´¹ç”¨å’Œæç¤º -->
    <view class="info-cards">
      <!-- æŠ¥åè¦æ±‚ -->
      <view wx:if="{{detail.requirements}}" class="info-tip-card info-tip-card--orange">
        <text class="info-tip-title">âš ï¸ æŠ¥åè¦æ±‚</text>
        <text class="info-tip-text">{{detail.requirements}}</text>
      </view>

      <!-- è´¹ç”¨è¯´æ˜ -->
      <view class="info-tip-card info-tip-card--blue">
        <text class="info-tip-title">ğŸ’° è´¹ç”¨è¯´æ˜</text>
        <text class="info-tip-text">{{feeInfo}}</text>
      </view>

      <!-- æ¸©é¦¨æç¤º -->
      <view class="info-tip-card info-tip-card--gray">
        <text class="info-tip-title">ğŸ“Œ æ¸©é¦¨æç¤º</text>
        <view class="info-tip-list">
          <block wx:for="{{guidelines}}" wx:key="index" wx:for-item="tip">
            <text class="info-tip-item">â€¢ {{tip}}</text>
          </block>
        </view>
      </view>
    </view>

    <!-- åè®® -->
    <view class="agreement-box">
      <checkbox-group bindchange="toggleAgree">
        <checkbox value="agree" checked="{{agree}}" class="agreement-checkbox" />
      </checkbox-group>
      <text class="agreement-text">å·²é˜…è¯»å¹¶åŒæ„ã€Šæ´»åŠ¨æŠ¥ååè®®ã€‹å’Œã€Šéšç§æ”¿ç­–ã€‹</text>
    </view>
  </view>
</view>

<view wx:if="{{!showGroupSelection}}" class="section">
  <view class="card shadow-card participants-card-reg">
    <view class="row-between mb-16">
      <text class="text-lg text-gray-800">å·²æŠ¥åäººå‘˜ ({{participants.length}})</text>
      <view class="text-sm text-blue-500" bindtap="viewAllParticipants" hover-class="none" wx:if="{{participants.length > 0}}">æŸ¥çœ‹å…¨éƒ¨</view>
    </view>
    <!-- åªå±•ç¤ºä¸€è¡Œå¤´åƒï¼ˆæœ€å¤š8ä¸ªï¼‰ -->
    <view class="participants-row-reg" wx:if="{{participants.length > 0}}">
      <block wx:for="{{participants}}" wx:key="id" wx:for-item="item" wx:for-index="idx">
        <view wx:if="{{idx < 8}}" class="participants-avatar-item-reg">
          <image src="{{item.avatar}}" mode="cover" class="participants-avatar-img-reg" />
        </view>
      </block>
      <!-- å¦‚æœè¶…è¿‡8ä¸ªï¼Œæ˜¾ç¤ºæ›´å¤šæç¤º -->
      <view wx:if="{{participants.length > 8}}" class="participants-more-reg" bindtap="viewAllParticipants">
        <text class="participants-more-text-reg">+{{participants.length - 8}}</text>
      </view>
    </view>
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{participants.length === 0}}" class="participants-empty-reg">
      <text class="text-sm text-gray-400">æš‚æ— æŠ¥åäººå‘˜</text>
    </view>
  </view>
</view>

<view class="bottom-space"></view>
<view class="fixed-footer">
  <button class="btn btn--secondary footer-btn" bindtap="cancel">è¿”å›</button>
  <button wx:if="{{!showGroupSelection}}" class="btn {{isRegistered ? 'btn--danger' : 'btn--primary'}} footer-btn" bindtap="{{isRegistered ? 'cancelRegistration' : 'submit'}}">{{isRegistered ? 'å–æ¶ˆæŠ¥å' : 'ç¡®è®¤æŠ¥å'}}</button>
</view>
