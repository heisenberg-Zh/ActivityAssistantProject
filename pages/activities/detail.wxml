<!-- pages/activities/detail.wxml -->

<!-- æ— æƒé™æç¤ºé¡µé¢ -->
<view wx:if="{{!hasPermission}}" class="permission-denied-page">
  <view class="permission-denied-content">
    <text class="permission-icon">ğŸ”’</text>
    <text class="permission-title">æ— æ³•æŸ¥çœ‹æ­¤æ´»åŠ¨</text>
    <text class="permission-message">{{permissionDeniedReason}}</text>
    <text class="permission-hint">è¿™æ˜¯ä¸€ä¸ªç§å¯†æ´»åŠ¨ï¼Œä»…åˆ›å»ºè€…å’Œå·²æŠ¥åè€…å¯è§</text>
    <view class="permission-actions">
      <!-- å¦‚æœæ˜¯é€šè¿‡åˆ†äº«è¿›æ¥çš„ï¼Œæä¾›è¿”å›æŒ‰é’® -->
      <button wx:if="{{fromShare}}" class="btn btn--primary" bindtap="goBack">è¿”å›</button>
      <!-- å¦‚æœä¸æ˜¯é€šè¿‡åˆ†äº«è¿›æ¥çš„ï¼Œæä¾›è¿”å›é¦–é¡µæŒ‰é’® -->
      <navigator wx:else url="/pages/home/index" open-type="switchTab" class="btn btn--primary">è¿”å›é¦–é¡µ</navigator>
      <!-- æµè§ˆå…¬å¼€æ´»åŠ¨æŒ‰é’® -->
      <navigator url="/pages/activities/list" open-type="switchTab" class="btn btn--secondary">æµè§ˆå…¬å¼€æ´»åŠ¨</navigator>
    </view>
  </view>
</view>

<!-- æ­£å¸¸æ´»åŠ¨è¯¦æƒ…é¡µé¢ -->
<view wx:else>
<view class="detail-header">
  <text class="detail-title">{{detail.title}}</text>
  <view class="favorite-icon {{isFavorited ? 'favorite-icon--active' : ''}}" bindtap="toggleFavorite">
    <view class="star-icon"></view>
  </view>
</view>

<view class="detail-cover-container">
  <image class="detail-cover-image" src="{{detail.imageUrl}}" mode="aspectFill"></image>
  <view class="detail-cover-overlay"></view>

  <!-- æ´»åŠ¨ç±»å‹æ ‡ç­¾ - å³ä¸Šè§’ -->
  <view class="detail-type-badge">
    <text class="detail-type-text">{{detail.type}}</text>
  </view>

  <!-- æ´»åŠ¨çŠ¶æ€æ ‡ç­¾ - å·¦ä¸‹è§’ -->
  <view class="detail-status-badge detail-status-badge--{{detail.statusClass}}">
    <text class="detail-status-text">{{detail.status}}</text>
  </view>
</view>

<view class="section">
  <view class="card shadow-card detail-card">
    <view class="organizer">
      <view class="organizer-avatar">{{extra.organizerInitial}}</view>
      <view class="flex-col">
        <text class="text-md text-gray-800">{{extra.organizer}}</text>
        <text class="text-xs text-gray-500">æ´»åŠ¨ç»„ç»‡è€…</text>
      </view>

      <!-- è”ç³»æŒ‰é’® -->
      <view class="contact-buttons" wx:if="{{canViewContact}}">
        <!-- ç”µè¯æŒ‰é’® -->
        <view wx:if="{{detail.organizerPhone}}" class="contact-btn" bindtap="callOrganizer">
          <view class="contact-icon contact-icon--phone"></view>
          <text class="contact-btn__text">ç”µè¯</text>
        </view>
        <!-- å¾®ä¿¡æŒ‰é’® -->
        <view wx:if="{{detail.organizerWechat}}" class="contact-btn" bindtap="copyWechat">
          <view class="contact-icon contact-icon--wechat"></view>
          <text class="contact-btn__text">å¾®ä¿¡</text>
        </view>
      </view>

      <!-- æœªæŠ¥åæç¤º -->
      <view class="contact-buttons-locked" wx:if="{{!canViewContact}}">
        <view class="contact-btn-locked">
          <view class="contact-icon contact-icon--lock"></view>
          <text class="contact-btn__text-gray">æŠ¥ååå¯æŸ¥çœ‹è”ç³»æ–¹å¼</text>
        </view>
      </view>
    </view>

    <view class="info-list">
      <view class="info-item">
        <view class="info-item__icon" style="background:#DBEAFE; color:#1d4ed8;">ğŸ•</view>
        <view class="flex-col info-item__body">
          <text class="info-label">æ´»åŠ¨æ—¶é—´</text>
          <text class="info-value">{{detail.timeRange}}</text>
          <text class="info-hint">æŠ¥åæˆªæ­¢ï¼š{{extra.deadline}}</text>
        </view>
      </view>
      <view class="info-item" bindtap="openMap">
        <view class="info-item__icon" style="background:#DCFCE7; color:#047857;">ğŸ“</view>
        <view class="flex-col info-item__body">
          <text class="info-label">æ´»åŠ¨åœ°ç‚¹</text>
          <text class="info-value">{{detail.place}}</text>
          <text class="info-hint">{{extra.addressDetail}}</text>
        </view>
      </view>
      <view class="info-item">
        <view class="info-item__icon" style="background:#FDE68A; color:#B45309;">ğŸ‘¥</view>
        <view class="flex-col info-item__body">
          <text class="info-label">å‚ä¸äººæ•°</text>
          <text class="info-value">{{detail.joined}} / {{detail.total}} äºº</text>
          <view class="progress mt-12"><view class="bar" style="width: {{progress}}%"></view></view>
        </view>
      </view>
      <view class="info-item">
        <view class="info-item__icon" style="background:#FEF3C7; color:#D97706;">ğŸ”–</view>
        <view class="flex-col info-item__body">
          <text class="info-label">æ´»åŠ¨ç¼–å·</text>
          <text class="info-value">{{detail.id}}</text>
          <text class="info-hint">æ´»åŠ¨å”¯ä¸€æ ‡è¯†</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- åˆ†ç»„ä¿¡æ¯ -->
<view class="section" wx:if="{{detail.hasGroups && detail.groups && detail.groups.length > 0}}">
  <view class="card shadow-card groups-section">
    <view class="groups-header">
      <text class="groups-title">æ´»åŠ¨åˆ†ç»„</text>
      <text class="groups-subtitle">å…± {{detail.groups.length}} ä¸ªåˆ†ç»„</text>
    </view>

    <!-- åˆ†ç»„é€‰æ‹©å™¨ - æ¨ªå‘æ»šåŠ¨ -->
    <scroll-view scroll-x class="groups-scroll" show-scrollbar="{{false}}">
      <view class="groups-tabs">
        <block wx:for="{{detail.groups}}" wx:key="id" wx:for-item="group" wx:for-index="idx">
          <view class="group-tab-card {{currentGroupIndex === idx ? 'group-tab-card--active' : ''}}" bindtap="switchGroup" data-index="{{idx}}">
            <view class="group-tab-header">
              <text class="group-tab-name">{{group.name}}</text>
              <view class="group-tab-status {{group.joined >= group.total ? 'status-full' : 'status-ok'}}">
                <text class="status-text">{{group.joined >= group.total ? 'å·²æ»¡' : 'å¯æŠ¥'}}</text>
              </view>
            </view>
            <view class="group-tab-count">
              <text class="count-text">{{group.joined}}/{{group.total}} äºº</text>
            </view>
          </view>
        </block>
      </view>
    </scroll-view>

    <!-- å½“å‰åˆ†ç»„è¯¦æƒ… -->
    <view wx:if="{{detail.groups[currentGroupIndex]}}" class="group-detail-section">
      <!-- è´¹ç”¨ä¿¡æ¯ -->
      <view class="detail-info-card detail-info-card--primary">
        <view class="info-icon">ğŸ’°</view>
        <view class="info-content">
          <text class="info-label">æ´»åŠ¨è´¹ç”¨</text>
          <text class="info-value">{{detail.groups[currentGroupIndex].feeType}} {{detail.groups[currentGroupIndex].feeType !== 'å…è´¹' ? 'Â¥' + detail.groups[currentGroupIndex].fee : ''}}</text>
        </view>
      </view>

      <!-- æŠ¥åè¦æ±‚ -->
      <view wx:if="{{detail.groups[currentGroupIndex].requirements}}" class="detail-info-card detail-info-card--warning">
        <view class="info-icon">âš ï¸</view>
        <view class="info-content">
          <text class="info-label">æŠ¥åè¦æ±‚</text>
          <text class="info-text">{{detail.groups[currentGroupIndex].requirements}}</text>
        </view>
      </view>

      <!-- æ´»åŠ¨è¯´æ˜ -->
      <view wx:if="{{detail.groups[currentGroupIndex].description}}" class="detail-info-card detail-info-card--info">
        <view class="info-icon">ğŸ“</view>
        <view class="info-content">
          <text class="info-label">æ´»åŠ¨è¯´æ˜</text>
          <text class="info-text">{{detail.groups[currentGroupIndex].description}}</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- æ— åˆ†ç»„æ—¶çš„è´¹ç”¨å’Œè¯´æ˜ä¿¡æ¯ -->
<view class="section" wx:if="{{!detail.hasGroups}}">
  <view class="card shadow-card">
    <view class="info-item">
      <view class="info-item__icon" style="background:#E0E7FF; color:#4338CA;">ğŸ’°</view>
      <view class="flex-col info-item__body">
        <text class="info-label">æ´»åŠ¨è´¹ç”¨</text>
        <text class="info-value">{{extra.feeInfo}}</text>
      </view>
    </view>

    <view wx:if="{{detail.requirements}}" style="margin-top: 24rpx; padding: 20rpx; background: #fffbeb; border-radius: 12rpx; border-left: 4rpx solid #f59e0b;">
      <text class="text-sm text-gray-700" style="display: block; font-weight: 600; margin-bottom: 8rpx;">âš ï¸ æŠ¥åè¦æ±‚</text>
      <text class="text-sm text-gray-600">{{detail.requirements}}</text>
    </view>

    <view wx:if="{{detail.description}}" style="margin-top: 16rpx; padding: 20rpx; background: #eff6ff; border-radius: 12rpx; border-left: 4rpx solid #3b82f6;">
      <text class="text-sm text-gray-700" style="display: block; font-weight: 600; margin-bottom: 8rpx;">ğŸ“ æ´»åŠ¨è¯´æ˜</text>
      <text class="text-sm text-gray-600">{{detail.description}}</text>
    </view>
  </view>
</view>

<view class="section">
  <view class="card shadow-card participants-card">
    <view class="row-between mb-16">
      <text class="text-lg text-gray-800">å‚ä¸æˆå‘˜ ({{members.length}})</text>
      <view class="text-sm text-blue-500" bindtap="viewAllMembers" hover-class="none" wx:if="{{members.length > 0}}">æŸ¥çœ‹å…¨éƒ¨</view>
    </view>
    <!-- åªå±•ç¤ºä¸€è¡Œå¤´åƒï¼ˆæœ€å¤š8ä¸ªï¼‰ -->
    <view class="participants-row" wx:if="{{members.length > 0}}">
      <block wx:for="{{members}}" wx:key="id" wx:for-item="item" wx:for-index="idx">
        <view wx:if="{{idx < 8}}" class="participants-avatar-item">
          <image src="{{item.avatar}}" mode="cover" class="participants-avatar-img" />
        </view>
      </block>
      <!-- å¦‚æœè¶…è¿‡8ä¸ªï¼Œæ˜¾ç¤ºæ›´å¤šæç¤º -->
      <view wx:if="{{members.length > 8}}" class="participants-more" bindtap="viewAllMembers">
        <text class="participants-more-text">+{{members.length - 8}}</text>
      </view>
    </view>
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{members.length === 0}}" class="participants-empty">
      <text class="text-sm text-gray-400">æš‚æ— å‚ä¸è€…</text>
    </view>
  </view>
</view>

<view class="bottom-space"></view>
<view class="fixed-footer {{canManage ? 'fixed-footer--three-btn' : ''}}">
  <button wx:if="{{canManage}}" class="btn btn--secondary footer-btn" bindtap="goManagement">ç®¡ç†</button>
  <button class="btn btn--secondary footer-btn" open-type="share">åˆ†äº«</button>
  <button class="btn {{isRegistered ? 'btn--danger' : 'btn--primary'}} footer-btn" bindtap="{{isRegistered ? 'cancelRegistration' : 'goRegister'}}">{{isRegistered ? 'å–æ¶ˆæŠ¥å' : 'æŠ¥å'}}</button>
</view>
</view>
<!-- ç»“æŸ wx:else -->