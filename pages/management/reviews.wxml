<!-- pages/management/reviews.wxml -->
<view class="reviews-page">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="top-bar top-bar--fixed" style="padding-top: {{statusBarHeight}}px;">
    <view class="top-bar__group">
      <view class="icon-btn icon-btn--back" bindtap="goBack">
        <text class="back-icon">â€¹</text>
      </view>
      <text class="text-lg" style="margin-left: 16rpx;">è¯„ä»·ç®¡ç†</text>
    </view>
  </view>

  <!-- æ»šåŠ¨å®¹å™¨ -->
  <scroll-view
    class="page-scroll"
    scroll-y
    bindscrolltolower="onScrollToLower"
    refresher-enabled
    refresher-triggered="{{loading}}"
    bindrefresherrefresh="onRefresh"
    enable-back-to-top
    enhanced
    show-scrollbar="{{false}}"
    style="top: {{navBarHeight}}px; bottom: 0;"
  >
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view wx:if="{{statistics}}" class="statistics-section">
      <view class="stat-card">
        <view class="stat-header">
          <text class="stat-icon">â­</text>
          <text class="stat-title">è¯„ä»·æ¦‚è§ˆ</text>
        </view>
        <view class="stat-body">
          <view class="stat-item stat-item--primary">
            <text class="stat-value">{{statistics.averageRating || 0}}</text>
            <text class="stat-label">å¹³å‡è¯„åˆ†</text>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item stat-item--secondary">
            <text class="stat-value">{{statistics.totalReviews || 0}}</text>
            <text class="stat-label">è¯„ä»·æ€»æ•°</text>
          </view>
        </view>

        <!-- è¯„åˆ†åˆ†å¸ƒ -->
        <view class="rating-distribution">
          <view
            wx:for="{{[5,4,3,2,1]}}"
            wx:key="*this"
            class="rating-bar-row"
          >
            <text class="rating-label">{{item}}æ˜Ÿ</text>
            <view class="rating-bar-container">
              <view
                class="rating-bar-fill"
                style="width: {{statistics.totalReviews > 0 ? (statistics.ratingDistribution[item] / statistics.totalReviews * 100) : 0}}%;"
              ></view>
            </view>
            <text class="rating-count">{{statistics.ratingDistribution[item] || 0}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç­›é€‰å’Œæ’åºæ  -->
    <view class="filter-section">
      <view class="filter-group">
        <text class="filter-label">ç­›é€‰ï¼š</text>
        <view class="filter-chips">
          <view
            class="filter-chip {{filterRating === null ? 'filter-chip--active' : ''}}"
            bindtap="onFilterChange"
            data-rating="{{null}}"
          >
            å…¨éƒ¨
          </view>
          <view
            wx:for="{{[5,4,3,2,1]}}"
            wx:key="*this"
            class="filter-chip {{filterRating === item ? 'filter-chip--active' : ''}}"
            bindtap="onFilterChange"
            data-rating="{{item}}"
          >
            {{item}}æ˜Ÿ
          </view>
        </view>
      </view>

      <view class="sort-group">
        <text class="sort-label">æ’åºï¼š</text>
        <view class="sort-buttons">
          <view
            class="sort-btn {{sortBy === 'latest' ? 'sort-btn--active' : ''}}"
            bindtap="onSortChange"
            data-sort="latest"
          >
            æœ€æ–°
          </view>
          <view
            class="sort-btn {{sortBy === 'rating' ? 'sort-btn--active' : ''}}"
            bindtap="onSortChange"
            data-sort="rating"
          >
            è¯„åˆ†
          </view>
        </view>
      </view>
    </view>

    <!-- è¯„ä»·åˆ—è¡¨ -->
    <view class="reviews-list">
      <!-- åŠ è½½ä¸­ -->
      <view wx:if="{{loading}}" class="loading-container">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{reviews.length === 0}}" class="empty-state">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-text">æš‚æ— è¯„ä»·</text>
        <text class="empty-hint">æ´»åŠ¨ç»“æŸåï¼Œå‚ä¸è€…å¯ä»¥æäº¤è¯„ä»·</text>
      </view>

      <!-- è¯„ä»·å¡ç‰‡ -->
      <view wx:else>
        <view wx:for="{{reviews}}" wx:key="id" class="review-card">
          <!-- ç”¨æˆ·ä¿¡æ¯ -->
          <view class="review-header">
            <image
              class="user-avatar"
              src="{{item.userAvatar || '/activityassistant_avatar_01.png'}}"
              mode="aspectFill"
            />
            <view class="user-info">
              <text class="user-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="review-time">{{item.formattedTime}}</text>
            </view>
            <!-- åˆ é™¤æŒ‰é’® -->
            <view
              class="delete-btn"
              bindtap="openDeleteModal"
              data-review-id="{{item.id}}"
              data-user-name="{{item.userName}}"
            >
              åˆ é™¤
            </view>
          </view>

          <!-- è¯„åˆ† -->
          <view class="review-rating">
            <view wx:for="{{item.stars}}" wx:key="index" class="star">
              <text class="star-icon {{item.filled ? 'star-filled' : 'star-empty'}}">â˜…</text>
            </view>
          </view>

          <!-- è¯„ä»·å†…å®¹ -->
          <view wx:if="{{item.content}}" class="review-content">
            <text class="content-text">{{item.content}}</text>
          </view>
        </view>

        <!-- åŠ è½½æ›´å¤š -->
        <view wx:if="{{hasMore}}" class="load-more">
          <text class="load-more-text">{{loadingMore ? 'åŠ è½½ä¸­...' : 'ä¸‹æ‹‰åŠ è½½æ›´å¤š'}}</text>
        </view>

        <!-- æ²¡æœ‰æ›´å¤š -->
        <view wx:else class="no-more">
          <text class="no-more-text">æ²¡æœ‰æ›´å¤šäº†</text>
        </view>
      </view>
    </view>

    <view class="bottom-space"></view>
  </scroll-view>

  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <view wx:if="{{showDeleteModal}}" class="modal-overlay" bindtap="closeDeleteModal">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">åˆ é™¤è¯„ä»·</text>
        <view class="modal-close" bindtap="closeDeleteModal">âœ•</view>
      </view>

      <view class="modal-body">
        <view class="warning-box">
          <text class="warning-icon">âš ï¸</text>
          <text class="warning-text">ç¡®å®šè¦åˆ é™¤ {{deleteTarget.userName}} çš„è¯„ä»·å—ï¼Ÿ</text>
        </view>

        <view class="form-field">
          <text class="field-label">åˆ é™¤åŸå›  <text class="required">*</text></text>
          <textarea
            class="field-textarea"
            placeholder="è¯·è¾“å…¥åˆ é™¤åŸå› ï¼ˆå¿…å¡«ï¼‰"
            value="{{deleteReason}}"
            bindinput="onDeleteReasonInput"
            maxlength="200"
            auto-height
          />
          <text class="field-hint">æ­¤æ“ä½œä¸å¯æ’¤é”€</text>
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn modal-btn--cancel" bindtap="closeDeleteModal">å–æ¶ˆ</button>
        <button class="modal-btn modal-btn--danger" bindtap="confirmDelete">ç¡®è®¤åˆ é™¤</button>
      </view>
    </view>
  </view>
</view>
