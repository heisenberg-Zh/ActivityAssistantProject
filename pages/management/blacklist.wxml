<!-- pages/management/blacklist.wxml -->
<view class="blacklist-page">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="top-bar top-bar--fixed" style="padding-top: {{statusBarHeight}}px;">
    <view class="top-bar__group">
      <view class="icon-btn icon-btn--back" bindtap="goBack">
        <text class="back-icon">â€¹</text>
      </view>
      <text class="text-lg" style="margin-left: 16rpx;">é»‘åå•ç®¡ç†</text>
    </view>
    <view class="top-bar__group">
      <view class="badge badge--danger">{{blacklist.length}} äºº</view>
    </view>
  </view>

  <!-- æç¤ºä¿¡æ¯ -->
  <view class="info-banner" style="margin-top: {{navBarHeight + 8}}px;">
    <view class="info-banner-icon">âš </view>
    <view class="info-banner-content">
      <text class="info-banner-title">ç¦æ­¢æŠ¥å</text>
      <text class="info-banner-desc">é»‘åå•ç”¨æˆ·å°†æ— æ³•æŠ¥åæ­¤æ´»åŠ¨ï¼Œæ”¯æŒè®¾ç½®è¿‡æœŸæ—¶é—´å’Œæ‰‹åŠ¨å¯ç”¨/ç¦ç”¨</text>
    </view>
  </view>

  <!-- é»‘åå•åˆ—è¡¨ -->
  <view class="list-container">
    <view wx:if="{{blacklist.length > 0}}" class="user-list">
      <block wx:for="{{blacklist}}" wx:key="phone">
        <view class="user-card user-card--blocked">
          <view class="user-card-main">
            <view wx:if="{{item.avatar}}" class="user-avatar-wrapper">
              <image src="{{item.avatar}}" mode="cover" class="user-avatar user-avatar--blocked"></image>
              <view class="user-badge user-badge--danger">Ã—</view>
            </view>
            <view wx:else class="user-avatar-wrapper">
              <view class="user-avatar-placeholder user-avatar-placeholder--blocked">{{item.name.charAt(0)}}</view>
              <view class="user-badge user-badge--danger">Ã—</view>
            </view>
            <view class="user-card-info">
              <text class="user-card-name">{{item.name}}</text>
              <text class="user-card-mobile">{{item.phone}}</text>
              <text wx:if="{{item.reason}}" class="user-card-reason">{{item.reason}}</text>
            </view>
          </view>
          <view class="user-card-status">
            <view class="status-chip status-chip--{{item.isExpired ? 'expired' : (item.isActive ? 'active' : 'disabled')}}">
              {{item.statusText}}
            </view>
          </view>
          <view class="user-card-actions">
            <view
              class="action-btn action-btn--{{item.isActive ? 'toggle' : 'enable'}}"
              bindtap="toggleActive"
              data-phone="{{item.phone}}"
              data-name="{{item.name}}"
              data-is-active="{{item.isActive}}"
            >
              {{item.isActive ? 'ç¦ç”¨' : 'å¯ç”¨'}}
            </view>
            <view
              class="action-icon-btn action-icon-btn--danger"
              bindtap="removeItem"
              data-phone="{{item.phone}}"
              data-name="{{item.name}}"
            >
              <text class="action-icon">Ã—</text>
            </view>
          </view>
        </view>
      </block>
    </view>

    <view wx:else class="empty-placeholder">
      <view class="empty-placeholder-icon">ğŸš«</view>
      <text class="empty-placeholder-title">æš‚æ— é»‘åå•ç”¨æˆ·</text>
      <text class="empty-placeholder-desc">ç‚¹å‡»ä¸‹æ–¹æ‚¬æµ®æŒ‰é’®æ·»åŠ é»‘åå•</text>
    </view>
  </view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab-container">
    <view class="fab-button fab-button--danger" bindtap="showAddDialog">
      <text class="fab-icon">+</text>
      <text class="fab-text">æ·»åŠ é»‘åå•</text>
    </view>
  </view>

  <!-- æ·»åŠ é»‘åå•å¯¹è¯æ¡† -->
  <view wx:if="{{showAddDialog}}" class="dialog-overlay">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header" catchtap="stopPropagation">
        <text class="dialog-title">æ·»åŠ é»‘åå•</text>
        <view class="dialog-close" catchtap="closeAddDialog">âœ•</view>
      </view>

      <view class="dialog-body" catchtap="stopPropagation">
        <view class="input-mode" catchtap="stopPropagation">
          <!-- è¾“å…¥å’Œé¢„è§ˆåŒºåŸŸ -->
          <view class="phone-input-container">
            <!-- å·¦ä¾§ï¼šè¾“å…¥åŒº -->
            <view class="phone-input-section">
              <view class="section-header">
                <text class="section-title">è¾“å…¥æ‰‹æœºå·</text>
                <text class="section-hint">æ¯è¡Œä¸€ä¸ª</text>
              </view>
              <textarea
                class="phone-textarea"
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰&#10;ä¾‹å¦‚ï¼š&#10;13800138000&#10;13900139000&#10;æ”¯æŒç²˜è´´æ‰¹é‡å¯¼å…¥"
                value="{{batchPhoneText}}"
                bindinput="onPhoneTextInput"
                catchtap="stopPropagation"
                catchlongpress="stopPropagation"
                maxlength="-1"
              ></textarea>
            </view>

            <!-- å³ä¾§ï¼šå®æ—¶é¢„è§ˆ -->
            <view class="phone-preview-section">
              <view class="section-header">
                <text class="section-title">è¯†åˆ«ç»“æœ</text>
                <text wx:if="{{phoneValidation.duplicates.length > 0}}" class="remove-duplicates-btn" catchtap="removeDuplicates">å»é‡</text>
              </view>
              <scroll-view scroll-y class="preview-list">
                <!-- æœ‰æ•ˆæ‰‹æœºå· -->
                <view wx:if="{{phoneValidation.valid.length > 0}}" class="preview-group">
                  <view class="preview-group-title">
                    <view class="status-dot status-dot--danger"></view>
                    <text>æœ‰æ•ˆ ({{phoneValidation.valid.length}})</text>
                  </view>
                  <view wx:for="{{phoneValidation.valid}}" wx:key="*this" class="preview-item preview-item--danger">
                    <text class="preview-phone">{{item}}</text>
                    <view wx:if="{{phoneValidation.existing.includes(item)}}" class="preview-tag preview-tag--warning">å·²å­˜åœ¨</view>
                  </view>
                </view>

                <!-- é‡å¤æ‰‹æœºå· -->
                <view wx:if="{{phoneValidation.duplicates.length > 0}}" class="preview-group">
                  <view class="preview-group-title">
                    <view class="status-dot status-dot--warning"></view>
                    <text>é‡å¤ ({{phoneValidation.duplicates.length}})</text>
                  </view>
                  <view wx:for="{{phoneValidation.duplicates}}" wx:key="*this" class="preview-item preview-item--duplicate">
                    <text class="preview-phone">{{item}}</text>
                    <view class="preview-tag preview-tag--duplicate">é‡å¤</view>
                  </view>
                </view>

                <!-- æ— æ•ˆæ‰‹æœºå· -->
                <view wx:if="{{phoneValidation.invalid.length > 0}}" class="preview-group">
                  <view class="preview-group-title">
                    <view class="status-dot status-dot--error"></view>
                    <text>æ— æ•ˆ ({{phoneValidation.invalid.length}})</text>
                  </view>
                  <view wx:for="{{phoneValidation.invalid}}" wx:key="*this" class="preview-item preview-item--invalid">
                    <text class="preview-phone">{{item}}</text>
                    <view class="preview-tag preview-tag--error">æ ¼å¼é”™è¯¯</view>
                  </view>
                </view>

                <!-- ç©ºçŠ¶æ€ -->
                <view wx:if="{{phoneValidation.valid.length === 0 && phoneValidation.invalid.length === 0 && phoneValidation.duplicates.length === 0}}" class="preview-empty">
                  <text class="preview-empty-icon">ğŸ“±</text>
                  <text class="preview-empty-text">è¾“å…¥åå®æ—¶é¢„è§ˆ</text>
                </view>
              </scroll-view>
            </view>
          </view>

          <!-- åº•éƒ¨ç»Ÿè®¡ -->
          <view class="phone-stats">
            <view class="stat-item">
              <text class="stat-label">å¯æ·»åŠ </text>
              <text class="stat-value stat-value--danger">{{phoneValidation.validCount}}</text>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <text class="stat-label">é‡å¤</text>
              <text class="stat-value stat-value--warning">{{phoneValidation.duplicates.length}}</text>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <text class="stat-label">æ— æ•ˆ</text>
              <text class="stat-value stat-value--error">{{phoneValidation.invalid.length}}</text>
            </view>
          </view>

          <!-- åŸå› å’ŒæœŸé™è®¾ç½® -->
          <view class="settings-section">
            <!-- åŸå› è¾“å…¥ -->
            <view class="setting-item">
              <view class="setting-header">
                <text class="setting-label">æ‹‰é»‘åŸå› </text>
                <text class="setting-hint">é€‰å¡«</text>
              </view>
              <textarea
                class="reason-textarea"
                placeholder="è¯·è¾“å…¥æ‹‰é»‘åŸå› ï¼ˆè‡³å°‘2ä¸ªå­—ï¼‰&#10;ä¾‹å¦‚ï¼šè¿åæ´»åŠ¨è§„åˆ™ã€æ¶æ„åˆ·å•ç­‰"
                value="{{blockReason}}"
                bindinput="onReasonInput"
                catchtap="stopPropagation"
                maxlength="100"
                auto-height
              ></textarea>
            </view>

            <!-- æœŸé™è®¾ç½® -->
            <view class="setting-item">
              <view class="setting-header">
                <text class="setting-label">æ‹‰é»‘æœŸé™</text>
                <view class="duration-tabs">
                  <view class="duration-tab {{isPermanent ? 'duration-tab--active' : ''}}" catchtap="selectPermanent">
                    æ°¸ä¹…
                  </view>
                  <view class="duration-tab {{!isPermanent ? 'duration-tab--active' : ''}}" catchtap="selectTemporary">
                    ä¸´æ—¶
                  </view>
                </view>
              </view>
              <view wx:if="{{!isPermanent}}" class="duration-input-wrapper">
                <input
                  class="duration-input"
                  type="number"
                  placeholder="è¾“å…¥å¤©æ•°"
                  value="{{expiryDays}}"
                  bindinput="onExpiryDaysInput"
                  catchtap="stopPropagation"
                />
                <text class="duration-unit">å¤©åè‡ªåŠ¨è§£é™¤</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="dialog-footer" catchtap="stopPropagation">
        <view class="btn btn--secondary" catchtap="closeAddDialog">å–æ¶ˆ</view>
        <view class="btn btn--danger" catchtap="confirmAdd">ç¡®å®š</view>
      </view>
    </view>
  </view>

  <view class="bottom-space"></view>
</view>
