<!-- pages/management/whitelist.wxml -->
<view class="whitelist-page">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="top-bar top-bar--fixed" style="padding-top: {{statusBarHeight}}px;">
    <view class="top-bar__group">
      <view class="icon-btn icon-btn--back" bindtap="goBack">
        <text class="back-icon">â€¹</text>
      </view>
      <text class="text-lg" style="margin-left: 16rpx;">ç™½åå•ç®¡ç†</text>
    </view>
    <view class="top-bar__group">
      <view class="badge badge--ok">{{whitelist.length}} äºº</view>
    </view>
  </view>

  <!-- æç¤ºä¿¡æ¯ -->
  <view class="info-banner">
    <view class="info-banner-icon">âœ“</view>
    <view class="info-banner-content">
      <text class="info-banner-title">è‡ªåŠ¨é€šè¿‡å®¡æ ¸</text>
      <text class="info-banner-desc">ç™½åå•ç”¨æˆ·æŠ¥ååè‡ªåŠ¨é€šè¿‡ï¼ˆä»…å¯¹éœ€è¦å®¡æ ¸çš„æ´»åŠ¨æœ‰æ•ˆï¼‰</text>
    </view>
  </view>

  <!-- ç™½åå•åˆ—è¡¨ -->
  <view class="list-container">
    <view wx:if="{{whitelist.length > 0}}" class="user-list">
      <block wx:for="{{whitelist}}" wx:key="phone">
        <view class="user-card">
          <view class="user-card-main">
            <view wx:if="{{item.avatar}}" class="user-avatar-wrapper">
              <image src="{{item.avatar}}" mode="cover" class="user-avatar"></image>
              <view class="user-badge user-badge--success">âœ“</view>
            </view>
            <view wx:else class="user-avatar-wrapper">
              <view class="user-avatar-placeholder">{{item.name.charAt(0)}}</view>
              <view class="user-badge user-badge--success">âœ“</view>
            </view>
            <view class="user-card-info">
              <text class="user-card-name">{{item.name}}</text>
              <text class="user-card-mobile">{{item.phone}}</text>
            </view>
          </view>
          <view class="user-card-action" bindtap="removeItem" data-phone="{{item.phone}}" data-name="{{item.name}}">
            <view class="action-icon-btn action-icon-btn--danger">
              <text class="action-icon">Ã—</text>
            </view>
          </view>
        </view>
      </block>
    </view>

    <view wx:else class="empty-placeholder">
      <view class="empty-placeholder-icon">ğŸ“‹</view>
      <text class="empty-placeholder-title">æš‚æ— ç™½åå•ç”¨æˆ·</text>
      <text class="empty-placeholder-desc">ç‚¹å‡»ä¸‹æ–¹æ‚¬æµ®æŒ‰é’®æ·»åŠ ç™½åå•</text>
    </view>
  </view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab-container">
    <view class="fab-button fab-button--success" bindtap="showAddDialog">
      <text class="fab-icon">+</text>
      <text class="fab-text">æ·»åŠ ç™½åå•</text>
    </view>
  </view>

  <!-- æ·»åŠ ç™½åå•å¯¹è¯æ¡† -->
  <view wx:if="{{showAddDialog}}" class="dialog-overlay">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header" catchtap="stopPropagation">
        <text class="dialog-title">æ·»åŠ ç™½åå•</text>
        <view class="dialog-close" catchtap="closeAddDialog">âœ•</view>
      </view>

      <!-- æ¨¡å¼åˆ‡æ¢ -->
      <view class="mode-tabs" catchtap="stopPropagation">
        <view
          class="mode-tab {{addMode === 'phone' ? 'mode-tab--active' : ''}}"
          catchtap="switchAddMode"
          data-mode="phone"
        >
          æ‰¹é‡æ‰‹æœºå·
        </view>
        <view
          class="mode-tab {{addMode === 'user' ? 'mode-tab--active' : ''}}"
          catchtap="switchAddMode"
          data-mode="user"
        >
          ä»å·²æŠ¥åé€‰æ‹©
        </view>
      </view>

      <view class="dialog-body" catchtap="stopPropagation">
        <!-- æ‰¹é‡æ‰‹æœºå·æ¨¡å¼ -->
        <view wx:if="{{addMode === 'phone'}}" class="input-mode" catchtap="stopPropagation">
          <!-- è¾“å…¥å’Œé¢„è§ˆåŒºåŸŸ -->
          <view class="phone-input-container">
            <!-- å·¦ä¾§ï¼šè¾“å…¥åŒº -->
            <view class="phone-input-section">
              <view class="section-header">
                <text class="section-title">è¾“å…¥æ‰‹æœºå·</text>
                <text class="section-hint">æ¯è¡Œä¸€ä¸ª</text>
              </view>
              <textarea
                class="phone-textarea"
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰&#10;ä¾‹å¦‚ï¼š&#10;13800138000&#10;13900139000&#10;æ”¯æŒç²˜è´´æ‰¹é‡å¯¼å…¥"
                value="{{batchPhoneText}}"
                bindinput="onPhoneTextInput"
                catchtap="{{null}}"
                catchlongpress="{{null}}"
                maxlength="-1"
              ></textarea>
            </view>

            <!-- å³ä¾§ï¼šå®æ—¶é¢„è§ˆ -->
            <view class="phone-preview-section">
              <view class="section-header">
                <text class="section-title">è¯†åˆ«ç»“æœ</text>
                <text wx:if="{{phoneValidation.duplicates.length > 0}}" class="remove-duplicates-btn" catchtap="removeDuplicates">å»é‡</text>
              </view>
              <scroll-view scroll-y class="preview-list">
                <!-- æœ‰æ•ˆæ‰‹æœºå· -->
                <view wx:if="{{phoneValidation.valid.length > 0}}" class="preview-group">
                  <view class="preview-group-title">
                    <view class="status-dot status-dot--success"></view>
                    <text>æœ‰æ•ˆ ({{phoneValidation.valid.length}})</text>
                  </view>
                  <view wx:for="{{phoneValidation.valid}}" wx:key="*this" class="preview-item preview-item--valid">
                    <text class="preview-phone">{{item}}</text>
                    <view wx:if="{{phoneValidation.existing.includes(item)}}" class="preview-tag preview-tag--warning">å·²å­˜åœ¨</view>
                  </view>
                </view>

                <!-- é‡å¤æ‰‹æœºå· -->
                <view wx:if="{{phoneValidation.duplicates.length > 0}}" class="preview-group">
                  <view class="preview-group-title">
                    <view class="status-dot status-dot--warning"></view>
                    <text>é‡å¤ ({{phoneValidation.duplicates.length}})</text>
                  </view>
                  <view wx:for="{{phoneValidation.duplicates}}" wx:key="*this" class="preview-item preview-item--duplicate">
                    <text class="preview-phone">{{item}}</text>
                    <view class="preview-tag preview-tag--duplicate">é‡å¤</view>
                  </view>
                </view>

                <!-- æ— æ•ˆæ‰‹æœºå· -->
                <view wx:if="{{phoneValidation.invalid.length > 0}}" class="preview-group">
                  <view class="preview-group-title">
                    <view class="status-dot status-dot--error"></view>
                    <text>æ— æ•ˆ ({{phoneValidation.invalid.length}})</text>
                  </view>
                  <view wx:for="{{phoneValidation.invalid}}" wx:key="*this" class="preview-item preview-item--invalid">
                    <text class="preview-phone">{{item}}</text>
                    <view class="preview-tag preview-tag--error">æ ¼å¼é”™è¯¯</view>
                  </view>
                </view>

                <!-- ç©ºçŠ¶æ€ -->
                <view wx:if="{{phoneValidation.valid.length === 0 && phoneValidation.invalid.length === 0 && phoneValidation.duplicates.length === 0}}" class="preview-empty">
                  <text class="preview-empty-icon">ğŸ“±</text>
                  <text class="preview-empty-text">è¾“å…¥åå®æ—¶é¢„è§ˆ</text>
                </view>
              </scroll-view>
            </view>
          </view>

          <!-- åº•éƒ¨ç»Ÿè®¡ -->
          <view class="phone-stats">
            <view class="stat-item">
              <text class="stat-label">å¯æ·»åŠ </text>
              <text class="stat-value stat-value--success">{{phoneValidation.validCount}}</text>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <text class="stat-label">é‡å¤</text>
              <text class="stat-value stat-value--warning">{{phoneValidation.duplicates.length}}</text>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <text class="stat-label">æ— æ•ˆ</text>
              <text class="stat-value stat-value--error">{{phoneValidation.invalid.length}}</text>
            </view>
          </view>
        </view>

        <!-- ä»å·²æŠ¥åç”¨æˆ·é€‰æ‹©æ¨¡å¼ -->
        <view wx:if="{{addMode === 'user'}}" class="user-mode" catchtap="stopPropagation">
          <!-- æœç´¢æ  -->
          <view class="search-bar">
            <view class="search-input-wrapper">
              <text class="search-icon">ğŸ”</text>
              <input
                class="search-input"
                placeholder="æœç´¢å§“åæˆ–æ‰‹æœºå·"
                value="{{searchKeyword}}"
                bindinput="onSearchInput"
                catchtap="{{null}}"
              />
              <view wx:if="{{searchKeyword}}" class="search-clear" catchtap="clearSearch">âœ•</view>
            </view>
          </view>

          <!-- é¡¶éƒ¨æ“ä½œæ  -->
          <view class="user-actions">
            <view class="user-count-info">
              <text class="count-text">å…± {{filteredUsers.length}} äºº</text>
              <text wx:if="{{selectedUserIds.length > 0}}" class="selected-text">å·²é€‰ {{selectedUserIds.length}} äºº</text>
            </view>
            <view class="batch-actions">
              <text wx:if="{{canSelectAll}}" class="batch-btn" catchtap="selectAll">å…¨é€‰</text>
              <text wx:if="{{selectedUserIds.length > 0}}" class="batch-btn" catchtap="clearSelection">æ¸…ç©º</text>
            </view>
          </view>

          <!-- ç”¨æˆ·åˆ—è¡¨ -->
          <scroll-view scroll-y class="user-scroll">
            <!-- å¯æ·»åŠ ç”¨æˆ· -->
            <view wx:if="{{availableUsers.length > 0}}" class="user-group">
              <view class="user-group-header">
                <text class="user-group-title">å¯æ·»åŠ  ({{availableUsers.length}})</text>
              </view>
              <block wx:for="{{availableUsers}}" wx:key="userId">
                <view
                  class="user-select-item {{item.isSelected ? 'user-select-item--selected' : ''}}"
                  catchtap="toggleUserSelection"
                  data-user-id="{{item.userId}}"
                >
                  <view class="user-checkbox {{item.isSelected ? 'user-checkbox--checked' : ''}}">
                    <text wx:if="{{item.isSelected}}" class="checkbox-icon">âœ“</text>
                  </view>
                  <image src="{{item.avatar}}" mode="cover" class="user-select-avatar"></image>
                  <view class="user-select-info">
                    <text class="user-select-name">{{item.name}}</text>
                    <text class="user-select-mobile">{{item.mobile}}</text>
                  </view>
                </view>
              </block>
            </view>

            <!-- å·²åœ¨ç™½åå•ç”¨æˆ· -->
            <view wx:if="{{existingUsers.length > 0}}" class="user-group">
              <view class="user-group-header">
                <text class="user-group-title">å·²åœ¨ç™½åå• ({{existingUsers.length}})</text>
              </view>
              <block wx:for="{{existingUsers}}" wx:key="userId">
                <view class="user-select-item user-select-item--disabled">
                  <view class="user-checkbox user-checkbox--disabled">
                    <text class="checkbox-icon">âœ“</text>
                  </view>
                  <image src="{{item.avatar}}" mode="cover" class="user-select-avatar"></image>
                  <view class="user-select-info">
                    <text class="user-select-name">{{item.name}}</text>
                    <text class="user-select-mobile">{{item.mobile}}</text>
                  </view>
                  <view class="user-select-status">å·²æ·»åŠ </view>
                </view>
              </block>
            </view>

            <!-- ç©ºçŠ¶æ€ -->
            <view wx:if="{{filteredUsers.length === 0}}" class="empty-state">
              <text class="empty-icon">{{searchKeyword ? 'ğŸ”' : 'ğŸ‘¥'}}</text>
              <text class="empty-text">{{searchKeyword ? 'æœªæ‰¾åˆ°åŒ¹é…ç”¨æˆ·' : 'æš‚æ— å·²æŠ¥åç”¨æˆ·'}}</text>
              <text wx:if="{{searchKeyword}}" class="empty-hint">è¯•è¯•å…¶ä»–å…³é”®è¯</text>
            </view>
          </scroll-view>
        </view>
      </view>

      <view class="dialog-footer" catchtap="stopPropagation">
        <view class="btn btn--secondary" catchtap="closeAddDialog">å–æ¶ˆ</view>
        <view class="btn btn--primary" catchtap="confirmAdd">ç¡®å®š</view>
      </view>
    </view>
  </view>

  <view class="bottom-space"></view>
</view>
